name: è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒ

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è·å–é¡¹ç›®ä¿¡æ¯
        id: project-info
        run: |
          # ä»pom.xmlæå–é¡¹ç›®ä¿¡æ¯
          PROJECT_NAME=$(mvn help:evaluate -Dexpression=project.name -q -DforceStdout | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
          if [ "$PROJECT_NAME" = "null" ]; then
            PROJECT_NAME=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)
          fi
          
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout | tr -d '\n')
          
          echo "name=${PROJECT_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: è®¾ç½®Javaç¯å¢ƒ
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Mavenæ„å»ºé¡¹ç›®
        run: mvn -B clean package

      - name: éªŒè¯æ„å»ºç»“æœ
        run: |
          if [ ! -d "target" ]; then
            echo "::error::æ„å»ºå¤±è´¥ï¼Œæœªç”Ÿæˆtargetç›®å½•"
            exit 1
          fi
          echo "=== æ„å»ºäº§ç‰© ==="
          ls -lh target/

      - name: è·å–æäº¤ä¿¡æ¯
        id: get-commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:%B)
          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
        id: file-hashes
        run: |
          set -euo pipefail

          echo "## ğŸ“¦ æ–‡ä»¶æ ¡éªŒå“ˆå¸Œ" > hashes.md
          echo '```' >> hashes.md

          found_files=false
          for file in target/*.jar; do
            if [[ -f "$file" ]]; then
              hash=$(sha256sum "$file" | awk '{print $1}')
              filename=$(basename "$file")
              echo "${filename}: ${hash}" >> hashes.md
              found_files=true
            fi
          done

          if [[ "$found_files" == false ]]; then
            echo "::warning::æœªæ‰¾åˆ°å¯æ ¡éªŒæ–‡ä»¶"
            echo "hash_content=æœªç”Ÿæˆæ ¡éªŒä¿¡æ¯" >> $GITHUB_OUTPUT
          else
            echo '```' >> hashes.md
            echo "hash_content<<EOF" >> $GITHUB_OUTPUT
            cat hashes.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: è®°å½•æ„å»ºæ—¶é—´
        id: get-date
        run: |
          echo "date=$(date +'%Yå¹´%mæœˆ%dæ—¥ %Hæ—¶%Måˆ†%Sç§’')" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºç‰ˆæœ¬å‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.project-info.outputs.version }}
          name: ${{ steps.project-info.outputs.name }}-v${{ steps.project-info.outputs.version }}
          body: |
            ## ğŸ“ æäº¤ä¿¡æ¯
            ```
            ${{ steps.get-commit.outputs.commit_msg }}
            ```

            ## ğŸ”§ æ„å»ºè¯¦æƒ…
            - é¡¹ç›®åç§°: ${{ steps.project-info.outputs.name }}
            - ç‰ˆæœ¬å·: ${{ steps.project-info.outputs.version }}
            - æäº¤å“ˆå¸Œ: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            - æ„å»ºæ—¶é—´: ${{ steps.get-date.outputs.date }}

            ## ğŸ” æ–‡ä»¶æ ¡éªŒ
            ${{ steps.file-hashes.outputs.hash_content }}

            > æœ¬å‘å¸ƒç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ
          files: |
            target/*.jar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
